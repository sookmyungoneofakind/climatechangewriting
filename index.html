<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA 북극 해빙 변화 탐사기 (수정됨)</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF & html2canvas CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        .dot-button {
            border: 3px dotted black; background-color: #f1f5f9; font-weight: 600;
            padding: 0.5rem 1rem; transition: all 0.2s ease-in-out; border-radius: 8px;
            box-shadow: 4px 4px 0px #94a3b8;
        }
        .dot-button:hover {
            background-color: #e2e8f0; box-shadow: 6px 6px 0px #475569;
            transform: translate(-2px, -2px);
        }
        .dot-button:active {
            background-color: #cbd5e1; box-shadow: 1px 1px 0px black;
            transform: translate(2px, 2px);
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%;
            width: 60px; height: 60px; animation: spin 2s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type=range] {
            -webkit-appearance: none; width: 100%; height: 10px; background: #d1d5db;
            outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 5px;
        }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: #3b82f6; cursor: pointer; border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%;
        }
        .data-source-selector {
            background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 1rem;
        }
        .alert-box {
            background: #fef3cd; border: 2px solid #fbbf24; border-radius: 8px; padding: 1rem;
            color: #92400e;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 bg-white my-10 rounded-xl shadow-lg">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">NASA 북극 해빙 변화 탐사기</h1>
            <p class="text-gray-600 mt-2">연도별 해빙 농도(Sea Ice Concentration) 지도를 통해 북극의 변화를 관찰해보세요.</p>
        </header>

        <!-- 데이터 소스 선택 -->
        <div class="data-source-selector mb-6">
            <h3 class="font-bold text-gray-800 mb-3">데이터 소스 선택</h3>
            <div class="flex flex-wrap gap-4">
                <label class="flex items-center">
                    <input type="radio" name="data-source" value="modis-sea-ice" checked class="mr-2">
                    <span>MODIS Terra 해빙 분류 (권장)</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="data-source" value="modis-aqua-sea-ice" class="mr-2">
                    <span>MODIS Aqua 해빙 분류</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="data-source" value="modis-terra" class="mr-2">
                    <span>MODIS Terra True Color</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="data-source" value="viirs" class="mr-2">
                    <span>VIIRS True Color</span>
                </label>
            </div>
        </div>

        <!-- 컨트롤 패널 -->
        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8 flex flex-col md:flex-row gap-6 items-center justify-around">
            <!-- 연도 선택 1 -->
            <div class="w-full md:w-2/5">
                <label for="year-slider-1" class="block text-center font-semibold text-gray-700">
                    기준 연도: <span id="year-label-1" class="font-bold text-blue-600 text-lg"></span>
                </label>
                <input id="year-slider-1" type="range" min="2012" class="w-full mt-2">
            </div>
            
            <div class="flex items-center justify-center">
                <label for="compare-toggle" class="mr-2 font-semibold text-gray-700">비교 모드</label>
                <input type="checkbox" id="compare-toggle" class="h-6 w-6 rounded text-blue-600 focus:ring-blue-500" checked>
            </div>

            <!-- 연도 선택 2 (비교 모드) -->
            <div id="year-selector-2" class="w-full md:w-2/5">
                <label for="year-slider-2" class="block text-center font-semibold text-gray-700">
                    비교 연도: <span id="year-label-2" class="font-bold text-red-600 text-lg"></span>
                </label>
                <input id="year-slider-2" type="range" min="2012" class="w-full mt-2">
            </div>
        </div>

        <!-- 지도 및 범례를 감싸는 메인 컨테이너 -->
        <div class="flex flex-col items-center gap-6">
            <!-- 2D 지도 표시 영역 -->
            <div id="map-container-wrapper" class="w-full grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-200 rounded-lg p-2 relative min-h-[300px] md:min-h-[512px]">
                 <div id="map-container-1" class="w-full h-full flex justify-center items-center bg-black rounded-md">
                     <div class="text-center text-white p-4">
                         <div class="loader mb-4"></div>
                         <p>지도 로딩 중...</p>
                     </div>
                 </div>
                 <div id="map-container-2" class="w-full h-full flex justify-center items-center bg-black rounded-md">
                     <div class="text-center text-white p-4">
                         <div class="loader mb-4"></div>
                         <p>지도 로딩 중...</p>
                     </div>
                 </div>
            </div>

            <!-- 범례 (Legend) -->
            <div class="w-full max-w-2xl bg-gray-50 p-4 rounded-lg shadow-inner">
                <h3 class="font-bold text-center mb-3" id="legend-title">해빙 농도 (%)</h3>
                <div class="flex items-center gap-4 px-2" id="legend-content">
                    <span class="text-sm font-semibold text-blue-800">얼음 없음 (0%)</span>
                    <div class="flex-grow h-6 bg-gradient-to-r from-blue-800 via-yellow-300 to-red-600 rounded-md border border-gray-300"></div>
                    <span class="text-sm font-semibold text-red-700">얼음 100%</span>
                </div>
            </div>
        </div>

        <!-- 영어 글쓰기 영역 -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">✏️ English Writing Practice</h2>
            <textarea id="writing-area" class="w-full h-80 p-6 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-lg leading-relaxed" 
                      placeholder="두 연도의 해빙 농도 지도를 비교하며 다음 질문에 대해 영어로 작성해보세요.

- What do the different colors on the map represent? (지도에 나타난 색은 무엇을 의미하나요?)
- How has the sea ice concentration in the Arctic changed between the two years? (두 연도 사이에 북극의 해빙 농도는 어떻게 변했나요?)
- What could be the causes of this change? (이러한 변화의 원인은 무엇일까요?)
- What are the potential consequences for the planet? (이 변화가 지구에 미칠 잠재적인 영향은 무엇일까요?)"></textarea>
        </div>

        <div class="text-center mt-8">
            <button id="save-pdf-btn" class="dot-button">결과 보고서 PDF로 저장하기</button>
        </div>
    </div>

    <script>
        // 사용 가능한 데이터 소스와 레이어 정의
        const DATA_SOURCES = {
            'modis-sea-ice': {
                name: 'MODIS Terra 해빙 분류',
                baseUrl: 'https://gibs.earthdata.nasa.gov/wms/epsg3413/best/wms.cgi',
                layer: 'MODIS_Terra_Sea_Ice',
                dateFormat: 'YYYY-09-15',
                legendTitle: '해빙 분류',
                legendGradient: 'from-pink-600 via-blue-400 to-green-600',
                legendStart: '해빙 (분홍)',
                legendEnd: '육지 (녹색)'
            },
            'modis-aqua-sea-ice': {
                name: 'MODIS Aqua 해빙 분류',
                baseUrl: 'https://gibs.earthdata.nasa.gov/wms/epsg3413/best/wms.cgi',
                layer: 'MODIS_Aqua_Sea_Ice',
                dateFormat: 'YYYY-09-15',
                legendTitle: '해빙 분류 (Aqua)',
                legendGradient: 'from-pink-600 via-blue-400 to-green-600',
                legendStart: '해빙 (분홍)',
                legendEnd: '육지 (녹색)'
            },
            'modis-terra': {
                name: 'MODIS Terra True Color',
                baseUrl: 'https://gibs.earthdata.nasa.gov/wms/epsg3413/best/wms.cgi',
                layer: 'MODIS_Terra_CorrectedReflectance_TrueColor',
                dateFormat: 'YYYY-09-15',
                legendTitle: 'True Color 이미지',
                legendGradient: 'from-blue-800 via-white to-brown-600',
                legendStart: '바다/얼음',
                legendEnd: '육지'
            },
            'viirs': {
                name: 'VIIRS True Color',
                baseUrl: 'https://gibs.earthdata.nasa.gov/wms/epsg3413/best/wms.cgi',
                layer: 'VIIRS_SNPP_CorrectedReflectance_TrueColor',
                dateFormat: 'YYYY-09-15',
                legendTitle: 'VIIRS True Color',
                legendGradient: 'from-blue-800 via-white to-brown-600',
                legendStart: '바다/얼음',
                legendEnd: '육지'
            }
        };

        // 현재 사용 중인 데이터 소스
        let currentDataSource = 'modis-sea-ice';
        
        const mostRecentGuaranteedYear = new Date().getFullYear() - 1;
        
        const yearSlider1 = document.getElementById('year-slider-1');
        const yearLabel1 = document.getElementById('year-label-1');
        const yearSlider2 = document.getElementById('year-slider-2');
        const yearLabel2 = document.getElementById('year-label-2');
        const compareToggle = document.getElementById('compare-toggle');
        const yearSelector2 = document.getElementById('year-selector-2');
        const mapContainer1 = document.getElementById('map-container-1');
        const mapContainer2 = document.getElementById('map-container-2');
        const savePdfBtn = document.getElementById('save-pdf-btn');
        const mapWrapper = document.getElementById('map-container-wrapper');
        const legendTitle = document.getElementById('legend-title');
        const legendContent = document.getElementById('legend-content');

        function updateLegend() {
            const source = DATA_SOURCES[currentDataSource];
            legendTitle.textContent = source.legendTitle;
            
            const gradientDiv = legendContent.querySelector('.flex-grow');
            gradientDiv.className = `flex-grow h-6 bg-gradient-to-r ${source.legendGradient} rounded-md border border-gray-300`;
            
            legendContent.querySelector('.text-blue-800').textContent = source.legendStart;
            legendContent.querySelector('.text-red-700').textContent = source.legendEnd;
        }

        function toggleLoading(container, show, message = '지도 로딩 중...') {
            if (show) {
                container.innerHTML = `
                    <div class="text-center text-white p-4">
                        <div class="loader mb-4"></div>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        function updateMapForYear(container, year) {
            const source = DATA_SOURCES[currentDataSource];
            const targetDate = source.dateFormat.replace('YYYY', year);
            
            toggleLoading(container, true, `${year}년 ${source.name} 로딩 중...`);
            
            const img = new Image();
            img.crossOrigin = "anonymous";

            const mapUrl = `${source.baseUrl}?SERVICE=WMS&REQUEST=GetMap&LAYERS=${source.layer}&VERSION=1.3.0&FORMAT=image/png&CRS=EPSG:3413&BBOX=-4194304,-4194304,4194304,4194304&WIDTH=512&HEIGHT=512&TIME=${targetDate}`;
            
            console.log(`Loading map for ${year}: ${mapUrl}`);
            img.src = mapUrl;

            img.onload = () => {
                container.innerHTML = '';
                img.className = 'w-full h-auto object-contain';
                container.appendChild(img);
            };

            img.onerror = () => {
                container.innerHTML = `
                    <div class="text-center text-white p-4">
                        <div class="text-yellow-400 text-6xl mb-4">⚠️</div>
                        <p class="text-lg mb-2">이미지를 불러오는 데 실패했습니다</p>
                        <p class="text-sm opacity-75">데이터가 없는 연도이거나 서비스에 문제가 있을 수 있습니다</p>
                        <p class="text-xs mt-2">시도한 연도: ${year}</p>
                        <p class="text-xs">데이터 소스: ${source.name}</p>
                    </div>
                `;
            };
        }
        
        function updateAllMaps() {
            updateMapForYear(mapContainer1, yearSlider1.value);
            if (compareToggle.checked) {
                updateMapForYear(mapContainer2, yearSlider2.value);
            }
        }
        
        function setupControls() {
            [yearSlider1, yearSlider2].forEach(slider => {
                slider.min = 2012;
                slider.max = mostRecentGuaranteedYear;
            });
            
            const defaultYear2 = mostRecentGuaranteedYear;
            const defaultYear1 = Math.max(2012, mostRecentGuaranteedYear - 10);

            yearSlider1.value = defaultYear1;
            yearLabel1.textContent = defaultYear1;
            
            yearSlider2.value = defaultYear2;
            yearLabel2.textContent = defaultYear2;
        }

        function initializeApp() {
            setupControls();
            updateLegend();
            updateAllMaps();
        }

        // 이벤트 리스너
        yearSlider1.addEventListener('input', e => yearLabel1.textContent = e.target.value);
        yearSlider1.addEventListener('change', () => updateMapForYear(mapContainer1, yearSlider1.value));

        yearSlider2.addEventListener('input', e => yearLabel2.textContent = e.target.value);
        yearSlider2.addEventListener('change', () => updateMapForYear(mapContainer2, yearSlider2.value));

        compareToggle.addEventListener('change', () => {
            const isChecked = compareToggle.checked;
            yearSelector2.classList.toggle('hidden', !isChecked);
            mapContainer2.classList.toggle('hidden', !isChecked);
            
            if (isChecked) {
                mapWrapper.classList.add('md:grid-cols-2');
                mapWrapper.classList.remove('md:grid-cols-1');
                updateMapForYear(mapContainer2, yearSlider2.value);
            } else {
                mapWrapper.classList.remove('md:grid-cols-2');
                mapWrapper.classList.add('md:grid-cols-1');
            }
        });

        // 데이터 소스 변경 이벤트
        document.querySelectorAll('input[name="data-source"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentDataSource = e.target.value;
                updateLegend();
                updateAllMaps();
            });
        });

        savePdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const elementToCapture = document.getElementById('app-container');
            const loaders = elementToCapture.querySelectorAll('.loader');
            loaders.forEach(loader => loader.style.display = 'none');

            html2canvas(elementToCapture, { scale: 2, useCORS: true, allowTaint: true })
            .then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`nasa-sea-ice-report-${new Date().toISOString().slice(0,10)}.pdf`);
            }).catch(err => {
                console.error("PDF creation error:", err);
                alert("PDF 생성 중 오류가 발생했습니다. 다시 시도해주세요.");
            }).finally(() => {
                 loaders.forEach(loader => loader.style.display = 'block');
            });
        });

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
