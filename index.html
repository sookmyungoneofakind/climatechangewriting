<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NASA 3D 지구 데이터 통합 탐사기</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- jsPDF & html2canvas CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- CesiumJS CDN -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    
    <script>
        // CesiumJS 라이브러리 스크립트가 로드되기 *전에* BASE_URL을 먼저 설정합니다.
        window.CESIUM_BASE_URL = 'https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/';
    </script>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.117/Build/Cesium/Cesium.js"></script>


    <style>
        body { font-family: 'Inter', sans-serif; }
        .dot-button {
            border: 3px dotted black; background-color: #f1f5f9; font-weight: 600;
            padding: 0.5rem 1rem; transition: all 0.2s ease-in-out; border-radius: 8px;
            box-shadow: 4px 4px 0px #94a3b8;
        }
        .dot-button:hover {
            background-color: #e2e8f0; box-shadow: 6px 6px 0px #475569;
            transform: translate(-2px, -2px);
        }
        .dot-button:active {
            background-color: #cbd5e1; box-shadow: 1px 1px 0px black;
            transform: translate(2px, 2px);
        }
        .loader {
            border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%;
            width: 60px; height: 60px; animation: spin 2s linear infinite;
            position: absolute; top: 50%; left: 50%; z-index: 10;
            transform: translate(-50%, -50%);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input[type=range] {
            -webkit-appearance: none; width: 100%; height: 10px; background: #d1d5db;
            outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 5px;
        }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
            background: #3b82f6; cursor: pointer; border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%;
        }
        .cesium-viewer-bottom, .cesium-viewer-toolbar { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app-container" class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 bg-white my-10 rounded-xl shadow-lg">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">NASA 3D 지구 데이터 통합 탐사기</h1>
            <p class="text-gray-600 mt-2">관찰하고 싶은 데이터 종류를 선택하고, 지구의 변화를 탐색해보세요.</p>
        </header>

        <!-- 컨트롤 패널 -->
        <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8 flex flex-col md:grid md:grid-cols-3 gap-6 items-center justify-center">
            <!-- 연도 선택 1 -->
            <div class="w-full">
                <label for="year-slider-1" class="block text-center font-semibold text-gray-700">
                    기준 연도: <span id="year-label-1" class="font-bold text-blue-600 text-lg">2012</span>
                </label>
                <input id="year-slider-1" type="range" min="2003" max="2023" value="2012" class="w-full mt-2">
            </div>
            
            <!-- 중앙 컨트롤 -->
            <div class="w-full flex flex-col items-center gap-4">
                 <div>
                    <label for="layer-selector" class="mr-2 font-semibold text-gray-700">데이터 종류</label>
                    <select id="layer-selector" class="rounded border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                        <option value="MODIS_Terra_CorrectedReflectance_TrueColor">위성 사진 (True Color)</option>
                        <option value="AMSR2_Sea_Ice_Concentration_12km">해빙 농도</option>
                    </select>
                </div>
                <div class="flex items-center">
                    <label for="compare-toggle" class="mr-2 font-semibold text-gray-700">비교 모드</label>
                    <input type="checkbox" id="compare-toggle" class="h-6 w-6 rounded text-blue-600 focus:ring-blue-500">
                </div>
            </div>

            <!-- 연도 선택 2 (비교 모드) -->
            <div id="year-selector-2" class="w-full hidden">
                <label for="year-slider-2" class="block text-center font-semibold text-gray-700">
                    비교 연도: <span id="year-label-2" class="font-bold text-red-600 text-lg">2023</span>
                </label>
                <input id="year-slider-2" type="range" min="2003" max="2023" value="2023" class="w-full mt-2">
            </div>
        </div>

        <!-- 3D 지구본 표시 영역 -->
        <div id="globe-container-wrapper" class="w-full min-h-[450px] bg-gray-200 rounded-lg p-2 relative flex justify-center items-center">
             <div id="cesium-container-1" class="w-full h-[400px] md:h-[500px] rounded-lg overflow-hidden relative"></div>
             <div id="cesium-container-2" class="w-full h-[400px] md:h-[500px] rounded-lg overflow-hidden relative hidden"></div>
             <div class="loader hidden"></div>
        </div>

        <!-- 영어 글쓰기 영역 -->
        <div class="mt-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">✍️ English Writing Practice</h2>
            <textarea id="writing-area" class="w-full h-64 p-4 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" 
                      placeholder="화면에 보이는 지구의 변화를 관찰하고, 자유롭게 영어로 작성해보세요."></textarea>
        </div>

        <div class="text-center mt-8">
            <button id="save-pdf-btn" class="dot-button">결과 보고서 PDF로 저장하기</button>
        </div>
    </div>

    <script>
        const LAYERS = {
          'MODIS_Terra_CorrectedReflectance_TrueColor': { name: '위성 사진 (True Color)', min: 2003, max: 2023 },
          'AMSR2_Sea_Ice_Concentration_12km': { name: '해빙 농도', min: 2012, max: 2024 }
        };
        const TARGET_DATE = '09-15'; 
        const BASE_URL = 'https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi';

        let viewer1, viewer2, layer1, layer2;
        let isSyncing = false;

        const yearSlider1 = document.getElementById('year-slider-1');
        const yearLabel1 = document.getElementById('year-label-1');
        const yearSlider2 = document.getElementById('year-slider-2');
        const yearLabel2 = document.getElementById('year-label-2');
        const compareToggle = document.getElementById('compare-toggle');
        const yearSelector2 = document.getElementById('year-selector-2');
        const globeWrapper = document.getElementById('globe-container-wrapper');
        const cesiumContainer1 = document.getElementById('cesium-container-1');
        const cesiumContainer2 = document.getElementById('cesium-container-2');
        const savePdfBtn = document.getElementById('save-pdf-btn');
        const loader = globeWrapper.querySelector('.loader');
        const layerSelector = document.getElementById('layer-selector');

        function toggleLoading(show) { loader.classList.toggle('hidden', !show); }
        
        function createViewer(containerId) {
            return new Cesium.Viewer(containerId, {
                imageryProvider: new Cesium.TileMapServiceImageryProvider({ url: Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII") }),
                baseLayerPicker: false, animation: false, timeline: false, homeButton: true,
                geocoder: false, sceneModePicker: false, navigationHelpButton: false,
                contextOptions: { webgl: { preserveDrawingBuffer: true } }
            });
        }

        function updateLayerForYear(viewer, year, currentLayer, layerName) {
            if (currentLayer) viewer.imageryLayers.remove(currentLayer);
            const provider = new Cesium.WebMapServiceImageryProvider({
                url: BASE_URL, layers: layerName,
                parameters: { transparent: 'true', format: 'image/png', time: `${year}-${TARGET_DATE}` }
            });
            return viewer.imageryLayers.addImageryProvider(provider);
        }
        
        function syncCameras(sourceViewer, targetViewer) {
            sourceViewer.camera.changed.addEventListener(() => {
                if (isSyncing) return;
                isSyncing = true;
                targetViewer.camera.setView({
                    destination: sourceViewer.camera.position,
                    orientation: {
                        heading: sourceViewer.camera.heading, pitch: sourceViewer.camera.pitch, roll: sourceViewer.camera.roll
                    }
                });
                isSyncing = false;
            });
        }
        
        async function updateGlobes() {
            toggleLoading(true);
            const loadPromises = [];
            const layerName = layerSelector.value;
            
            layer1 = updateLayerForYear(viewer1, yearSlider1.value, layer1, layerName);
            loadPromises.push(layer1.readyPromise);

            if (compareToggle.checked) {
                layer2 = updateLayerForYear(viewer2, yearSlider2.value, layer2, layerName);
                loadPromises.push(layer2.readyPromise);
            }
            try { await Promise.all(loadPromises); } 
            catch (error) { console.error("Layer loading error:", error); } 
            finally { toggleLoading(false); }
        }
        
        function updateSliderRanges() {
            const selectedLayer = LAYERS[layerSelector.value];
            const sliders = [yearSlider1, yearSlider2];
            const labels = [yearLabel1, yearLabel2];
            
            sliders.forEach((slider, index) => {
                slider.min = selectedLayer.min;
                slider.max = selectedLayer.max;
                // 현재 값이 범위를 벗어나면 조정
                slider.value = Math.max(selectedLayer.min, Math.min(selectedLayer.max, slider.value));
                labels[index].textContent = slider.value;
            });
        }

        function initializeApp() {
            viewer1 = createViewer('cesium-container-1');
            viewer2 = createViewer('cesium-container-2');
            
            const initialPosition = Cesium.Cartesian3.fromDegrees(0, 70, 10000000);
            viewer1.camera.setView({ destination: initialPosition });
            viewer2.camera.setView({ destination: initialPosition });

            syncCameras(viewer1, viewer2);
            syncCameras(viewer2, viewer1);
            
            updateSliderRanges();
            updateGlobes();
        }

        yearSlider1.addEventListener('input', e => yearLabel1.textContent = e.target.value);
        yearSlider1.addEventListener('change', updateGlobes);

        yearSlider2.addEventListener('input', e => yearLabel2.textContent = e.target.value);
        yearSlider2.addEventListener('change', updateGlobes);

        layerSelector.addEventListener('change', () => {
            updateSliderRanges();
            updateGlobes();
        });

        compareToggle.addEventListener('change', () => {
            const isChecked = compareToggle.checked;
            yearSelector2.classList.toggle('hidden', !isChecked);
            cesiumContainer2.classList.toggle('hidden', !isChecked);
            
            // [수정] 중앙 정렬을 위해 레이아웃 클래스 동적 제어
            if(isChecked) {
                globeWrapper.classList.remove('flex', 'justify-center', 'items-center');
                globeWrapper.classList.add('grid', 'grid-cols-1', 'md:grid-cols-2');
            } else {
                globeWrapper.classList.remove('grid', 'grid-cols-1', 'md:grid-cols-2');
                globeWrapper.classList.add('flex', 'justify-center', 'items-center');
                if (layer2) {
                    viewer2.imageryLayers.remove(layer2);
                    layer2 = null;
                }
            }
            if (isChecked) updateGlobes();
        });

        savePdfBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const elementToCapture = document.getElementById('app-container');
            console.log('PDF creation started.');
            toggleLoading(true);
            html2canvas(elementToCapture, { scale: 2, useCORS: true, allowTaint: true })
            .then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                pdf.save(`nasa-3d-report-${new Date().toISOString().slice(0,10)}.pdf`);
            }).catch(err => {
                console.error("PDF creation error:", err);
            }).finally(() => {
                toggleLoading(false);
            });
        });

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>

